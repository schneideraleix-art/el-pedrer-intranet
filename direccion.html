<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Maestro Pro - El Pedrer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-body: #f4f7fa;
            --sidebar-bg: #111827;
            --accent: #ff4757;
            --glass: rgba(255, 255, 255, 0.9);
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        body { background: var(--bg-body); font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; margin: 0; }

        /* SIDEBAR */
        .sidebar { width: 280px; background: var(--sidebar-bg); color: white; padding: 30px 20px; display: flex; flex-direction: column; }
        .nav-link { color: #9ca3af; padding: 12px 15px; border-radius: 12px; display: flex; align-items: center; gap: 12px; text-decoration: none; transition: 0.3s; margin-bottom: 5px; }
        .nav-link.active, .nav-link:hover { background: var(--accent); color: white; }

        /* MAIN */
        .content { flex-grow: 1; padding: 40px; overflow-y: auto; position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px; }

        /* CARDS */
        .grid-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 24px; box-shadow: var(--shadow); text-align: center; border: none; }
        .stat-card h3 { font-size: 2.2rem; font-weight: 800; margin: 5px 0; }

        .grid-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .action-card { 
            background: white; border-radius: 24px; padding: 30px; text-align: center; border: none;
            box-shadow: var(--shadow); transition: 0.3s; cursor: pointer; height: 100%;
        }
        .action-card:hover { transform: translateY(-8px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .action-card i { font-size: 2.5rem; display: block; margin-bottom: 15px; }

        /* MODAL CÁMARAS Y TECLADO */
        .overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 10001; align-items: center; justify-content: center; 
        }
        .cctv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 80%; max-width: 900px; }
        .cam { background: #000; aspect-ratio: 16/9; position: relative; border: 2px solid #333; overflow: hidden; }
        .cam::before { content: "REC ●"; position: absolute; top: 10px; left: 10px; color: red; font-size: 12px; z-index: 2; }

        /* MARCADOR TELEFÓNICO */
        .dialer { background: white; padding: 30px; border-radius: 30px; width: 320px; text-align: center; }
        .dial-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .dial-btn { width: 60px; height: 60px; border-radius: 50%; border: 1px solid #ddd; background: #f9f9f9; font-size: 1.5rem; transition: 0.2s; }
        .dial-btn:active { background: #eee; transform: scale(0.9); }

        /* PE-PHONE VoIP */
        .pe-phone { 
            display: none; position: fixed; bottom: 30px; right: 30px; width: 310px; height: 620px; 
            background: #000; border-radius: 50px; border: 10px solid #222; z-index: 10000; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.5); overflow: hidden; color: white; 
        }
        .phone-screen { height: 100%; display: flex; flex-direction: column; align-items: center; padding-top: 60px; background: linear-gradient(to bottom, #1e293b, #000); }
        .btn-round { width: 65px; height: 65px; border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3 class="fw-bold mb-5"><i class="bi bi-shield-lock-fill"></i> EL PEDRER</h3>
        <nav>
            <a href="#" class="nav-link active"><i class="bi bi-speedometer2"></i> Dashboard</a>
            <a href="#" class="nav-link"><i class="bi bi-people"></i> Claustro</a>
            <a href="#" class="nav-link"><i class="bi bi-clock"></i> Horarios</a>
            <a href="#" class="nav-link"><i class="bi bi-file-earmark-bar-graph"></i> Reportes</a>
        </nav>
        <div class="mt-auto bg-dark p-3 rounded-4">
            <div class="d-flex align-items-center gap-2 mb-3">
                <span class="p-1 bg-success rounded-circle"></span> <small>Centralita Lista</small>
            </div>
            <button class="btn btn-outline-light btn-sm w-100" onclick="activarAudio()">Desbloquear Audio</button>
        </div>
    </div>

    <div class="content">
        <div class="header">
            <h1 class="fw-bold">Gestión Directiva</h1>
            <div class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 p-3 rounded-pill">
                PeerID: elpedrer-direccion
            </div>
        </div>

        <div class="grid-stats">
            <div class="stat-card"><h6>ALUMNOS</h6><h3 class="text-danger">842</h3></div>
            <div class="stat-card"><h6>PROFESORES</h6><h3 class="text-primary">137</h3></div>
            <div class="stat-card"><h6>BAJAS HOY</h6><h3 class="text-warning">4</h3></div>
            <div class="stat-card"><h6>COMEDOR</h6><h3 class="text-success">315</h3></div>
        </div>

        <div class="grid-actions">
            <div class="action-card" onclick="sonarTimbre()">
                <i class="bi bi-bell-fill text-warning"></i>
                <h5 class="fw-bold">Timbre Manual</h5>
                <p class="small text-muted">Sirena general del centro</p>
            </div>
            <div class="action-card" onclick="toggleOverlay('modalDialer')">
                <i class="bi bi-telephone-plus-fill text-success"></i>
                <h5 class="fw-bold">Marcador Manual</h5>
                <p class="small text-muted">Llamada VoIP externa</p>
            </div>
            <div class="action-card" onclick="toggleOverlay('modalCCTV')">
                <i class="bi bi-camera-video-fill text-dark"></i>
                <h5 class="fw-bold">Cámaras CCTV</h5>
                <p class="small text-muted">Vigilancia en tiempo real</p>
            </div>
            <div class="action-card">
                <i class="bi bi-person-x-fill text-danger"></i>
                <h5 class="fw-bold">Control Bajas</h5>
                <p class="small text-muted">Gestión de ausencias</p>
            </div>
        </div>
    </div>

    <div id="modalCCTV" class="overlay" onclick="toggleOverlay('modalCCTV')">
        <div class="cctv-grid">
            <div class="cam"><div class="text-white p-2 small">PASILLO A</div></div>
            <div class="cam"><div class="text-white p-2 small">PATIO NORTE</div></div>
            <div class="cam"><div class="text-white p-2 small">ENTRADA PRINCIPAL</div></div>
            <div class="cam"><div class="text-white p-2 small">SECRETARÍA</div></div>
        </div>
    </div>

    <div id="modalDialer" class="overlay">
        <div class="dialer">
            <h4 class="fw-bold mb-3">Marcador VoIP</h4>
            <input type="text" id="dialDisplay" class="form-control form-control-lg text-center mb-3" readonly>
            <div class="dial-grid">
                <button class="dial-btn" onclick="press('1')">1</button><button class="dial-btn" onclick="press('2')">2</button><button class="dial-btn" onclick="press('3')">3</button>
                <button class="dial-btn" onclick="press('4')">4</button><button class="dial-btn" onclick="press('5')">5</button><button class="dial-btn" onclick="press('6')">6</button>
                <button class="dial-btn" onclick="press('7')">7</button><button class="dial-btn" onclick="press('8')">8</button><button class="dial-btn" onclick="press('9')">9</button>
                <button class="dial-btn text-danger" onclick="document.getElementById('dialDisplay').value=''"><i class="bi bi-x"></i></button>
                <button class="dial-btn" onclick="press('0')">0</button>
                <button class="dial-btn text-success" onclick="alert('Marcando...')"><i class="bi bi-telephone-fill"></i></button>
            </div>
            <button class="btn btn-link mt-3 text-dark" onclick="toggleOverlay('modalDialer')">Cerrar</button>
        </div>
    </div>

    <div id="pePhone" class="pe-phone">
        <div class="phone-screen">
            <div class="mb-4"><i class="bi bi-person-circle display-1 text-info"></i></div>
            <h2 id="callerID" class="fw-bold">LLAMADA</h2>
            <p id="callStatus" class="opacity-50">Entrante...</p>
            
            <div id="transferMenu" class="px-4 w-100 mt-4" style="display:none;">
                <button class="btn btn-outline-info w-100 mb-2" onclick="derivar('Secretaría')">EXT 01 - Secretaría</button>
                <button class="btn btn-outline-info w-100" onclick="derivar('Administración')">EXT 02 - Admin</button>
            </div>

            <div style="position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: space-around;">
                <button class="btn-round bg-danger" onclick="colgar()"><i class="bi bi-telephone-x-fill"></i></button>
                <button id="btnAccept" class="btn-round bg-success" onclick="aceptar()"><i class="bi bi-telephone-fill"></i></button>
            </div>
        </div>
    </div>

    <script>
        const sndRingtone = new Audio('https://serverside-docs.github.io/sounds/ringtone.mp3');
        const peer = new Peer('elpedrer-direccion');
        let callActiva = null;

        function activarAudio() {
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("Audio desbloqueado"));
        }

        function toggleOverlay(id) {
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
        }

        function press(num) {
            document.getElementById('dialDisplay').value += num;
            new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3').play();
        }

        function sonarTimbre() {
            new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3').play();
            alert("Timbre activado en todo el centro");
        }

        // PeerJS Logic
        peer.on('call', (call) => {
            callActiva = call;
            document.getElementById('pePhone').style.display = 'block';
            document.getElementById('callerID').innerText = (call.metadata.depto || "ENTRANTE").toUpperCase();
            sndRingtone.play(); sndRingtone.loop = true;
        });

        function aceptar() {
            sndRingtone.pause();
            document.getElementById('btnAccept').style.display = 'none';
            document.getElementById('transferMenu').style.display = 'block';
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                callActiva.answer(stream);
                callActiva.on('stream', remoteStream => {
                    const audio = document.createElement('audio');
                    audio.srcObject = remoteStream;
                    audio.play();
                    document.getElementById('callStatus').innerText = "CONVERSACIÓN ACTIVA";
                });
            });
        }

        function colgar() {
            if(callActiva) callActiva.close();
            location.reload();
        }

        function derivar(ext) {
            const tts = new SpeechSynthesisUtterance("Transfiriendo a " + ext);
            window.speechSynthesis.speak(tts);
            setTimeout(colgar, 3000);
        }
    </script>
</body>
</html>
