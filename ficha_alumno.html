<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema IVR El Pedrer - Versión Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root { --bot-color: #00d2ff; --human-color: #2ecc71; --bg-dark: #0f172a; }
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        
        .ficha-container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); overflow: hidden; max-width: 1000px; width: 90%; display: flex; min-height: 700px; }
        .sidebar { background: #1e293b; color: white; width: 300px; padding: 40px 20px; text-align: center; }
        
        /* Centralita */
        #callOverlay { 
            display: none; position: fixed; top: 30px; right: 30px; width: 380px; 
            background: var(--bg-dark); color: white; border-radius: 24px; padding: 30px; 
            box-shadow: 0 10px 50px rgba(0,0,0,0.5); z-index: 9999; text-align: center; border: 1px solid #334155;
        }

        .viz-box { display: flex; justify-content: center; align-items: flex-end; gap: 5px; height: 50px; margin: 20px 0; }
        .bar { width: 6px; height: 10px; background: var(--bot-color); border-radius: 3px; transition: 0.1s; }
        .animating { animation: pulse 0.8s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { height: 10px; } 50% { height: 45px; } }

        .bot-bubble { font-size: 0.95rem; background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; margin-bottom: 20px; border-left: 4px solid var(--bot-color); min-height: 90px; color: #cbd5e1; line-height: 1.5; }

        .mic-badge { display: none; background: #ef4444; color: white; padding: 5px 15px; border-radius: 50px; font-size: 0.75rem; font-weight: bold; margin-bottom: 15px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.4; } }

        .btn-hangup { background: #ef4444; border: none; color: white; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; transition: 0.3s; cursor: pointer; }
        .btn-hangup:hover { transform: scale(1.1) rotate(135deg); background: #dc2626; }

        .main-info { flex: 1; padding: 60px; }
    </style>
</head>
<body>

<audio id="waitingMusic" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" type="audio/mpeg">
</audio>

<div id="callOverlay">
    <div class="small text-uppercase tracking-widest opacity-50 mb-2" id="headerType">Sistema Asistido</div>
    <div class="mic-badge" id="micBadge"><i class="bi bi-mic-fill me-1"></i> ESCUCHANDO...</div>
    
    <div class="viz-box" id="viz">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>

    <div id="botSpeech" class="bot-bubble">Iniciando protocolo institucional...</div>
    
    <div class="d-flex justify-content-between align-items: center; mb-4 px-3">
        <div class="text-start">
            <small class="d-block opacity-50">ESTADO</small>
            <strong id="callStatus" class="text-info">CONECTANDO</strong>
        </div>
        <div class="text-end">
            <small class="d-block opacity-50">TIEMPO</small>
            <strong id="timerDisplay">00:00</strong>
        </div>
    </div>

    <button class="btn-hangup shadow" onclick="endCall()"><i class="bi bi-telephone-fill"></i></button>
</div>

<div class="ficha-container">
    <div class="sidebar">
        <div class="bg-primary rounded-circle d-inline-block p-4 mb-3"><i class="bi bi-person-badge text-white fs-1"></i></div>
        <h4 id="nombreAlumno">Expediente Alumno</h4>
        <p class="small opacity-50">Colegio El Pedrer</p>
        <hr class="border-secondary my-4">
        <button class="btn btn-success w-100 py-3 fw-bold rounded-pill shadow" onclick="runCallFlow()">
            <i class="bi bi-telephone-outbound-fill me-2"></i> INICIAR LLAMADA
        </button>
    </div>
    <div class="main-info">
        <h2 class="fw-bold mb-4">Panel de Control de Voz</h2>
        <p class="text-muted">Utilice el botón lateral para iniciar la comunicación. El sistema filtrará la llamada mediante el asistente virtual antes de conectar con el personal del centro.</p>
        <div class="card mt-5 border-0 bg-light p-4 rounded-4">
            <h6 class="text-uppercase small fw-bold mb-3">Registro de la sesión</h6>
            <div id="logArea" class="small text-muted italic">No hay actividad registrada.</div>
        </div>
    </div>
</div>

<script>
    const music = document.getElementById('waitingMusic');
    const synth = window.speechSynthesis;
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = Recognition ? new Recognition() : null;
    if(recognition) { recognition.lang = 'es-ES'; recognition.continuous = false; }

    let voiceBot, voiceHuman;
    let seconds = 0;
    let callTimer;

    const guionHumano = [
        "Buenos días, le atiende el centro educativo. He recibido su solicitud, ¿en qué puedo ayudarle?",
        "Entiendo. Respecto a su consulta sobre el alumno, estamos procesando la documentación necesaria.",
        "Correcto. Le enviaremos una notificación oficial a su correo electrónico al finalizar el día.",
        "Ha sido un placer atenderle. Procedo a cerrar la comunicación. Que tenga un buen día."
    ];

    function setupVoices() {
        const v = synth.getVoices();
        // Buscamos voces diferentes
        voiceBot = v.find(voz => voz.name.includes('Google') && voz.lang.includes('es')) || v[0];
        voiceHuman = v.find(voz => (voz.name.includes('Helena') || voz.name.includes('Microsoft')) && voz.lang.includes('es')) || v[1] || v[0];
    }
    synth.onvoiceschanged = setupVoices;
    setupVoices();

    function hablar(texto, quien) {
        return new Promise((resolve) => {
            synth.cancel();
            const u = new SpeechSynthesisUtterance(texto);
            u.lang = 'es-ES';
            
            if (quien === 'bot') {
                u.voice = voiceBot; u.pitch = 0.8; u.rate = 0.9;
                document.getElementById('headerType').innerText = "Asistente Virtual";
                document.querySelectorAll('.bar').forEach(b => b.style.background = '#00d2ff');
                document.getElementById('botSpeech').style.borderColor = '#00d2ff';
            } else {
                u.voice = voiceHuman; u.pitch = 1.0; u.rate = 0.95;
                document.getElementById('headerType').innerText = "Personal del Centro";
                document.querySelectorAll('.bar').forEach(b => b.style.background = '#2ecc71');
                document.getElementById('botSpeech').style.borderColor = '#2ecc71';
            }

            u.onstart = () => {
                document.getElementById('botSpeech').innerText = texto;
                document.querySelectorAll('.bar').forEach(b => b.classList.add('animating'));
            };
            u.onend = () => {
                document.querySelectorAll('.bar').forEach(b => b.classList.remove('animating'));
                resolve();
            };
            synth.speak(u);
        });
    }

    function escuchar() {
        return new Promise((resolve) => {
            if(!recognition) return setTimeout(() => resolve("si"), 2000);
            document.getElementById('micBadge').style.display = 'inline-block';
            recognition.start();
            recognition.onresult = (e) => {
                document.getElementById('micBadge').style.display = 'none';
                resolve(e.results[0][0].transcript.toLowerCase());
            };
            recognition.onerror = () => {
                document.getElementById('micBadge').style.display = 'none';
                resolve("");
            };
        });
    }

    async function runCallFlow() {
        // Desbloquear audio
        music.play().then(() => { music.pause(); music.currentTime = 0; });
        
        document.getElementById('callOverlay').style.display = 'block';
        document.getElementById('logArea').innerText = "Conexión establecida...";

        // ETAPA 1: BOT
        await hablar("Le damos la bienvenida al Colegio El Pedrer. ¿Autoriza usted la grabación de esta llamada por motivos de seguridad? Diga sí o no.", 'bot');
        await escuchar();
        
        await hablar("Le agradezco la información. Indique el departamento: uno para Secretaría, dos para Jefatura.", 'bot');
        await escuchar();

        await hablar("Estamos gestionando su transferencia. Por favor, manténgase a la espera.", 'bot');

        // ETAPA 2: MÚSICA
        document.getElementById('callStatus').innerText = "TRANSFERIENDO";
        music.volume = 0.2; music.play();

        setTimeout(async () => {
            music.pause();
            document.getElementById('callStatus').innerText = "EN LÍNEA";
            document.getElementById('callStatus').className = "text-success fw-bold";
            callTimer = setInterval(() => {
                seconds++;
                let m = Math.floor(seconds/60).toString().padStart(2,'0');
                let s = (seconds%60).toString().padStart(2,'0');
                document.getElementById('timerDisplay').innerText = `${m}:${s}`;
            }, 1000);

            // ETAPA 3: CONVERSACIÓN HUMANA
            for(let frase of guionHumano) {
                await hablar(frase, 'humano');
                document.getElementById('botSpeech').innerText = "(Le escuchamos...)";
                await escuchar();
            }
            endCall();
        }, 5000);
    }

    function endCall() {
        clearInterval(callTimer);
        music.pause();
        hablar("La sesión ha finalizado. Gracias por su contacto. Que tenga un buen día.", 'bot').then(() => {
            setTimeout(() => {
                document.getElementById('callOverlay').style.display = 'none';
                document.getElementById('logArea').innerText = `Llamada finalizada con éxito. Duración: ${seconds}s`;
                seconds = 0;
                document.getElementById('timerDisplay').innerText = "00:00";
            }, 2000);
        });
    }
</script>
</body>
</html>
