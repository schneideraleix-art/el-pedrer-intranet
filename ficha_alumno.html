<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expediente Pro - Colegio El Pedrer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #00d2ff; --success: #2ecc71; --whatsapp: #25D366; }
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        
        .sidebar { width: 280px; background: var(--primary); color: white; position: fixed; height: 100vh; padding: 30px; z-index: 100; }
        .main-content { margin-left: 280px; padding: 40px; }

        .card-custom { background: white; border-radius: 24px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.02); padding: 25px; margin-bottom: 25px; }

        /* Centralita Flotante */
        #callOverlay { 
            display: none; position: fixed; bottom: 30px; right: 30px; width: 350px; 
            background: #0f172a; color: white; border-radius: 30px; padding: 25px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.4); z-index: 9999; border: 1px solid #334155;
        }

        .viz-bar { width: 4px; height: 8px; background: var(--accent); border-radius: 10px; transition: 0.1s; }
        .animating { animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { height: 8px; } to { height: 35px; } }

        .bot-bubble { font-size: 0.85rem; background: rgba(255,255,255,0.06); padding: 15px; border-radius: 18px; margin: 15px 0; border-left: 4px solid var(--accent); }

        /* Botón WhatsApp Final */
        #whatsappBtn { display: none; background: var(--whatsapp); color: white; border: none; font-weight: bold; transition: 0.3s; }
        #whatsappBtn:hover { transform: scale(1.05); background: #1eb954; }
    </style>
</head>
<body>

<audio id="waitingMusic" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3"></audio>

<div class="sidebar text-center">
    <div class="bg-primary border border-secondary rounded-circle d-inline-block p-3 mb-3 shadow">
        <i class="bi bi-person-badge-fill fs-1 text-info"></i>
    </div>
    <h5 id="sideNombre" class="fw-bold mb-4">--</h5>
    
    <button class="btn btn-info w-100 py-3 fw-bold rounded-pill text-white shadow-lg mb-4" onclick="runCallFlow()">
        <i class="bi bi-telephone-outbound-fill me-2"></i> LLAMAR AHORA
    </button>

    <button id="whatsappBtn" class="btn w-100 py-3 rounded-pill shadow-lg" onclick="sendWhatsApp()">
        <i class="bi bi-whatsapp me-2"></i> ENVIAR INFORME
    </button>
</div>

<div class="main-content">
    <div class="row mb-4">
        <div class="col">
            <h2 class="fw-bold">Expediente: <span id="mainNombre" class="text-info">--</span></h2>
            <p class="text-muted">Interacción por voz y análisis de datos en tiempo real.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card-custom">
                <h6 class="fw-bold text-uppercase small text-muted mb-4">Evolución Académica (Interactivo)</h6>
                <canvas id="evolucionChart" height="140"></canvas>
            </div>
            <div class="card-custom">
                <h6 class="fw-bold text-uppercase small text-muted mb-4">Calificaciones actuales</h6>
                <table class="table align-middle">
                    <tbody id="tablaNotas"></tbody>
                </table>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card-custom bg-info text-white">
                <h6 class="opacity-75">Media Actual</h6>
                <h1 class="display-3 fw-bold mb-0">8.7</h1>
            </div>
            <div class="card-custom">
                <h6 class="fw-bold mb-3">Asistencia</h6>
                <div class="progress mb-2" style="height:10px"><div class="progress-bar bg-success" style="width: 96%"></div></div>
                <small class="text-muted">96% de asistencia positiva</small>
            </div>
        </div>
    </div>
</div>

<div id="callOverlay">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="badge bg-primary-subtle text-info">LLAMADA EN CURSO</span>
        <strong id="timer">00:00</strong>
    </div>

    <div id="botSpeech" class="bot-bubble">Listo para la gestión vocal.</div>
    
    <div class="d-flex justify-content-center gap-1 mb-4" id="viz">
        <div class="viz-bar"></div><div class="viz-bar"></div><div class="viz-bar"></div>
        <div class="viz-bar"></div><div class="viz-bar"></div><div class="viz-bar"></div>
    </div>

    <button class="btn btn-danger w-100 rounded-pill py-3 fw-bold shadow" onclick="endCall()">
        COLGAR LLAMADA
    </button>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const nombreAlumno = urlParams.get('nombre') || 'Alejandro Martínez';
    document.getElementById('sideNombre').innerText = nombreAlumno;
    document.getElementById('mainNombre').innerText = nombreAlumno;

    // Configuración Gráfica e Interacción de Voz
    const ctx = document.getElementById('evolucionChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Sep', 'Oct', 'Nov', 'Dic', 'Ene', 'Feb'],
            datasets: [{
                data: [7.5, 7.2, 8.0, 8.1, 8.5, 8.7],
                borderColor: '#00d2ff', backgroundColor: 'rgba(0, 210, 255, 0.1)',
                fill: true, tension: 0.4, borderWidth: 4, pointRadius: 6
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    const i = elements[0].index;
                    const nota = myChart.data.datasets[0].data[i];
                    hablar(`En el mes de ${myChart.data.labels[i]}, la nota media fue de ${nota}.`, 'bot');
                }
            }
        }
    });

    // Lógica de Notas
    const materias = ["Matemáticas", "Física", "Lengua", "Inglés"];
    const tabla = document.getElementById('tablaNotas');
    materias.forEach(m => {
        tabla.innerHTML += `<tr><td class="fw-bold">${m}</td><td class="text-end"><strong>8.5</strong></td></tr>`;
    });

    // SISTEMA DE VOZ
    const synth = window.speechSynthesis;
    const music = document.getElementById('waitingMusic');
    let timer, sec = 0;

    function hablar(texto, tipo) {
        return new Promise(r => {
            synth.cancel();
            const u = new SpeechSynthesisUtterance(texto);
            u.lang = 'es-ES';
            u.pitch = tipo === 'bot' ? 0.8 : 1.1;
            document.getElementById('botSpeech').innerText = texto;
            document.querySelectorAll('.viz-bar').forEach(b => b.classList.add('animating'));
            u.onend = () => { document.querySelectorAll('.viz-bar').forEach(b => b.classList.remove('animating')); r(); };
            synth.speak(u);
        });
    }

    async function runCallFlow() {
        music.play().then(() => { music.pause(); music.currentTime = 0; });
        document.getElementById('callOverlay').style.display = 'block';
        document.getElementById('whatsappBtn').style.display = 'none';
        await hablar("Iniciando llamada institucional para " + nombreAlumno, 'bot');
        music.volume = 0.1; music.play();
        setTimeout(async () => {
            music.pause();
            timer = setInterval(() => {
                sec++;
                document.getElementById('timer').innerText = `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
            }, 1000);
            await hablar("Buenos días. Le atendemos desde El Pedrer. ¿Desea comentar el expediente?", 'humano');
        }, 4000);
    }

    function endCall() {
        clearInterval(timer);
        music.pause();
        document.getElementById('callOverlay').style.display = 'none';
        document.getElementById('whatsappBtn').style.display = 'block'; // Aparece el botón de WhatsApp
        hablar("Gestión finalizada. Puede enviar el resumen por WhatsApp ahora.", 'bot');
    }

    function sendWhatsApp() {
        const mensaje = `Hola, le escribimos desde el Colegio El Pedrer. Tras nuestra llamada, le informamos que el alumno ${nombreAlumno} tiene una media actual de 8.7. Saludos.`;
        const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
        window.open(url, '_blank');
    }
</script>
</body>
</html>
