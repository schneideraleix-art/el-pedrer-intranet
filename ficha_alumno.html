<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Ficha - El Pedrer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .ficha-container { background: white; border-radius: 15px; box-shadow: 0 15px 50px rgba(0,0,0,0.1); overflow: hidden; max-width: 1000px; width: 95%; display: flex; min-height: 780px; position: relative; }
        
        /* Sidebar */
        .sidebar-ficha { background: #2c3e50; color: white; width: 35%; padding: 40px 30px; text-align: center; }
        .avatar-circle { width: 150px; height: 150px; background: #2ecc71; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; margin: 0 auto 20px; border: 5px solid rgba(255,255,255,0.1); text-transform: uppercase; }

        /* Centralita VoIP */
        #callOverlay { 
            display: none; position: fixed; top: 20px; right: 20px; width: 320px; 
            background: #121212; color: white; border-radius: 15px; padding: 25px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); z-index: 2000; text-align: center;
            border: 1px solid #333; animation: slideIn 0.4s ease;
        }
        .timer { font-family: 'Courier New', monospace; font-size: 1.5rem; color: #2ecc71; margin-bottom: 10px; display: block; }
        .btn-hangup { background: #ff4757; border: none; color: white; width: 55px; height: 55px; border-radius: 50%; font-size: 1.5rem; transition: 0.3s; }
        
        /* Panel Transferencia */
        #transferPanel { display: none; background: #222; border-radius: 10px; padding: 10px; margin-top: 15px; border: 1px dashed #555; }
        .btn-ext { background: #444; color: white; border: none; font-size: 0.75rem; margin: 2px; padding: 5px 10px; border-radius: 4px; width: 100%; text-align: left; }
        .btn-ext:hover { background: #007bff; }

        #contestadorMsg { 
            display: none; background: #2d3436; border-radius: 10px; padding: 10px; 
            font-size: 0.8rem; margin-bottom: 15px; border-left: 3px solid #f1c40f; color: #f1c40f; font-style: italic;
        }

        .rec-indicator { display: none; color: #ff4757; font-size: 0.7rem; font-weight: bold; position: absolute; top: 15px; left: 20px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        /* Contenido */
        .content-ficha { width: 65%; padding: 45px; position: relative; }
        .nav-tabs .nav-link { border: none; color: #888; font-weight: 600; cursor: pointer; }
        .nav-tabs .nav-link.active { color: #007bff; border-bottom: 3px solid #007bff; background: none; }
    </style>
</head>
<body>

<audio id="dialSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" loop></audio>
<audio id="beepSound" src="https://assets.mixkit.co/active_storage/sfx/2355/2354-preview.mp3"></audio>

<div id="callOverlay">
    <div class="rec-indicator" id="recIcon"><i class="bi bi-circle-fill me-1"></i> REC</div>
    <div class="small opacity-50 mb-2">EXTENSIÓN DIRECCIÓN</div>
    
    <div id="contestadorMsg">"Colegio El Pedrer, dígame..."</div>

    <h6 id="callStatus" class="mb-1">Marcando...</h6>
    <span class="timer" id="timerDisplay">00:00</span>
    
    <div class="d-flex justify-content-center align-items-center gap-2">
        <button class="btn btn-outline-warning btn-sm rounded-circle" id="btnRec" onclick="toggleRecording()"><i class="bi bi-record-circle"></i></button>
        <button class="btn-hangup shadow" onclick="endCall()"><i class="bi bi-telephone-x-fill"></i></button>
        <button class="btn btn-outline-info btn-sm rounded-circle" onclick="toggleTransfer()"><i class="bi bi-arrow-right-short"></i></button>
    </div>

    <div id="transferPanel">
        <div class="small mb-2 opacity-50">Transferir a:</div>
        <button class="btn-ext" onclick="transferTo('Secretaría')"><i class="bi bi-building me-2"></i> Secretaría (Ext. 101)</button>
        <button class="btn-ext" onclick="transferTo('Jefatura de Estudios')"><i class="bi bi-person-workspace me-2"></i> Jefatura (Ext. 102)</button>
        <button class="btn-ext" onclick="transferTo('Comedor')"><i class="bi bi-egg-fried me-2"></i> Comedor (Ext. 105)</button>
    </div>
</div>

<div class="ficha-container">
    <div class="sidebar-ficha">
        <div class="avatar-circle" id="avatarLetra">--</div>
        <h3 class="fw-bold mb-1" id="nombreAlumno">...</h3>
        <span class="badge bg-primary mb-4" id="niaAlumno">NIA: 0000000</span>
        
        <button class="btn btn-success w-100 fw-bold py-3 mb-3" onclick="startCall()">
            <i class="bi bi-telephone-plus-fill me-2"></i> CENTRALITA IP
        </button>

        <div class="text-start opacity-75 small border-top pt-3 mt-2">
            <p><i class="bi bi-telephone me-2"></i> Familia: +34 600 000 000</p>
        </div>
    </div>

    <div class="content-ficha">
        <a href="exp_alumnado.html" class="btn btn-sm btn-outline-secondary position-absolute" style="top: 25px; right: 25px;">Cerrar</a>
        <h4 class="fw-bold mb-4">Gestión de Expediente</h4>

        <ul class="nav nav-tabs mb-4">
            <li class="nav-item"><a class="nav-link active" onclick="showTab('notas')">Calificaciones</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('historial')">Log de Llamadas</a></li>
        </ul>

        <div id="sec-notas">
            <table class="table table-hover border small">
                <thead class="table-light"><tr><th>Asignatura</th><th class="text-center">Nota</th></tr></thead>
                <tbody id="notasCuerpo"></tbody>
            </table>
        </div>

        <div id="sec-historial" style="display:none;">
            <div id="historialLog" class="list-group list-group-flush">
                <div class="list-group-item small text-muted text-center">Sin registros hoy</div>
            </div>
        </div>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const nombre = params.get('nombre') || 'Estudiante';
    document.getElementById('nombreAlumno').innerText = nombre;
    document.getElementById('niaAlumno').innerText = "NIA: " + (params.get('nia') || '1084251');
    document.getElementById('avatarLetra').innerText = nombre[0].toUpperCase();

    // Notas
    ["Lengua", "Matemáticas", "Inglés", "Ciencias", "Ed. Física"].forEach(m => {
        document.getElementById('notasCuerpo').innerHTML += `<tr><td>${m}</td><td class="text-center fw-bold">8.0</td></tr>`;
    });

    let timer; let sec = 0; let isRecording = false;

    function startCall() {
        document.getElementById('callOverlay').style.display = 'block';
        document.getElementById('dialSound').play();
        document.getElementById('callStatus').innerText = "Llamando...";
        
        setTimeout(() => {
            if (document.getElementById('callOverlay').style.display === 'block') {
                document.getElementById('dialSound').pause();
                document.getElementById('contestadorMsg').style.display = 'block';
                document.getElementById('callStatus').innerText = "CONTESTADOR";
                document.getElementById('beepSound').play();
                timer = setInterval(() => { sec++; updateTimer(); }, 1000);
            }
        }, 4000);
    }

    function updateTimer() {
        let m = Math.floor(sec/60).toString().padStart(2,'0');
        let s = (sec%60).toString().padStart(2,'0');
        document.getElementById('timerDisplay').innerText = `${m}:${s}`;
    }

    function toggleTransfer() {
        const p = document.getElementById('transferPanel');
        p.style.display = p.style.display === 'none' ? 'block' : 'none';
    }

    function transferTo(dept) {
        alert("Transfiriendo llamada a: " + dept);
        addToLog("LLAMADA DESVIADA A " + dept.toUpperCase());
        closeCall();
    }

    function toggleRecording() {
        isRecording = !isRecording;
        document.getElementById('btnRec').classList.toggle('btn-warning');
        document.getElementById('recIcon').style.display = isRecording ? 'block' : 'none';
    }

    function endCall() {
        addToLog(sec > 0 ? "LLAMADA FINALIZADA ("+sec+"s)" : "LLAMADA PERDIDA");
        closeCall();
    }

    function closeCall() {
        clearInterval(timer);
        document.getElementById('dialSound').pause();
        document.getElementById('callStatus').innerText = "Cerrando...";
        setTimeout(() => {
            document.getElementById('callOverlay').style.display = 'none';
            document.getElementById('transferPanel').style.display = 'none';
            document.getElementById('contestadorMsg').style.display = 'none';
            sec = 0;
            document.getElementById('timerDisplay').innerText = "00:00";
        }, 1000);
    }

    function addToLog(msg) {
        const log = document.getElementById('historialLog');
        if (log.innerHTML.includes("Sin registros")) log.innerHTML = "";
        const recTag = isRecording ? ' <span class="badge bg-danger small">REC</span>' : '';
        log.innerHTML = `<div class="list-group-item small"><b>${msg}</b>${recTag}<div class="text-muted">Hoy - Centralita El Pedrer</div></div>` + log.innerHTML;
    }

    function showTab(t) {
        document.getElementById('sec-notas').style.display = t === 'notas' ? 'block' : 'none';
        document.getElementById('sec-historial').style.display = t === 'historial' ? 'block' : 'none';
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
