<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comunicación El Pedrer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background: #0f172a; height: 100vh; display: flex; align-items: center; justify-content: center; color: white; font-family: sans-serif; }
        .portal { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); padding: 40px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); text-align: center; width: 90%; max-width: 400px; }
        .btn-principal { background: #22c55e; border: none; padding: 20px; border-radius: 50px; width: 100%; font-weight: bold; font-size: 1.2rem; color: white; margin-top: 20px; }
        .btn-opt { background: #38bdf8; border: none; width: 100%; padding: 15px; border-radius: 15px; margin-bottom: 10px; color: black; font-weight: bold; display: none; }
        .bar { width: 5px; background: #22c55e; height: 5px; transition: 0.1s; display: inline-block; margin: 0 2px; }
    </style>
</head>
<body>

<div class="portal">
    <div id="inicio">
        <i class="bi bi-telephone-fill text-success" style="font-size: 3rem;"></i>
        <h2 class="fw-bold mt-3">Centro El Pedrer</h2>
        <button class="btn-principal" onclick="iniciar()">LLAMAR AHORA</button>
    </div>

    <div id="ivr" style="display:none;">
        <i class="bi bi-robot text-info" style="font-size: 3rem;"></i>
        <p id="status" class="mt-3">Iniciando sistema...</p>
        <div id="visualizer" style="height: 40px;">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>
        <div id="options" class="mt-4">
            <button class="btn-opt" onclick="llamar('Secretaría')">SECRETARÍA</button>
            <button class="btn-opt" onclick="llamar('Administración')">ADMINISTRACIÓN</button>
            <button class="btn-opt" onclick="llamar('Dirección')">DIRECCIÓN</button>
        </div>
    </div>
</div>

<script>
    const peer = new Peer();
    const sndHold = new Audio('https://www.soundjay.com/phone/sounds/phone-calling-1.mp3');

    function iniciar() {
        document.getElementById('inicio').style.display = 'none';
        document.getElementById('ivr').style.display = 'block';
        const msg = new SpeechSynthesisUtterance("Bienvenido. Seleccione departamento.");
        msg.lang = 'es-ES';
        msg.onend = () => document.querySelectorAll('.btn-opt').forEach(b => b.style.display = 'block');
        window.speechSynthesis.speak(msg);
    }

    function llamar(depto) {
        document.getElementById('options').style.display = 'none';
        document.getElementById('status').innerText = "Conectando...";
        sndHold.play(); sndHold.loop = true;

        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            const call = peer.call('elpedrer-direccion', stream, { metadata: { depto: depto } });
            
            call.on('stream', remoteStream => {
                sndHold.pause();
                const audio = document.createElement('audio');
                audio.srcObject = remoteStream;
                audio.play();
                document.getElementById('status').innerText = "EN LÍNEA";
            });
        });
    }
</script>
</body>
</html>
